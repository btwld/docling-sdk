# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Docling SDK is a TypeScript SDK that bridges the Python Docling ecosystem with JavaScript/TypeScript. It provides document conversion, OCR, and chunking capabilities through two client modes: API (HTTP/REST) and CLI (local Python wrapper).

## Common Commands

```bash
# Development
npm run build          # Production build with tsup
npm run dev            # Watch mode for development
npm run typecheck      # TypeScript type checking

# Testing
npm test               # Run unit tests (default)
npm run test:unit      # Unit tests only
npm run test:integration  # Integration tests
npm run test:all       # All tests
npm run test:coverage  # Coverage report (80% threshold)

# Code Quality
npm run lint           # Biome linting
npm run lint:fix       # Auto-fix lint issues
npm run format:fix     # Auto-format code
npm run check          # Full Biome check

# Run examples
npm run examples:basic-api
npm run examples:streaming
npm run examples:cli

# OpenAPI Type Generation
npm run openapi:fetch     # Fetch spec from Docling Serve (requires running server)
npm run openapi:generate  # Generate TypeScript types from spec
npm run openapi:update    # Fetch and generate in one command
```

## Architecture

### Dual Client System

The SDK uses a factory pattern with discriminated union configuration:

```typescript
// API client - connects to Docling Serve REST API
const apiClient = new Docling({ api: { baseUrl: 'http://localhost:5000' } });

// CLI client - wraps local Python Docling CLI
const cliClient = new Docling({ cli: { outputDir: './output' } });
```

**Factory entry point**: `src/docling.ts` - returns `DoclingAPIClient` or `DoclingCLIClient` based on config.

### Core Components

```
src/
├── docling.ts              # Main factory function
├── clients/
│   ├── api-client.ts       # HTTP client for Docling Serve API
│   ├── cli-client.ts       # Python CLI wrapper with retry logic
│   └── websocket-client.ts # Real-time task monitoring
├── services/
│   ├── file.ts             # File conversion (toMarkdown, toHtml, extractText)
│   ├── chunk.ts            # Document chunking (HybridChunker, HierarchicalChunker)
│   ├── async-task-manager.ts # Event-based task coordination with polling
│   └── progress-tracker.ts # Progress monitoring (HTTP/WebSocket/hybrid)
├── api/
│   ├── http.ts             # Custom HTTP client with connection pooling
│   └── connection-pool.ts  # Connection pool (50 max, 10 free sockets)
├── types/
│   ├── api.ts              # Manually maintained API types
│   ├── client.ts           # Client configuration types
│   ├── generated/          # Auto-generated types from OpenAPI spec
│   │   ├── api.ts          # Generated by openapi-typescript
│   │   └── index.ts        # Exports OpenAPI namespace
│   └── adapters/           # Type transformation adapters
│       ├── s3.ts           # S3 config adapters (SDK → OpenAPI format)
│       └── index.ts
├── openapi/                # OpenAPI spec files (fetched from server)
└── scripts/
    └── fetch-openapi.ts    # Script to fetch OpenAPI spec
```

### Key Patterns

- **Type guards**: `isAPIConfig()`, `isCLIConfig()`, `isAPIClient()`, `isCLIClient()` for discriminated unions
- **Result type**: `src/utils/result.ts` for safe error handling
- **Path aliases**: `@/types`, `@/api`, `@/cli`, `@/utils`, `@/websocket` (configured in tsconfig.json)
- **HTTP retry**: Exponential backoff on 408, 429, 500, 502, 503, 504

## Testing

- **Framework**: Vitest with globals enabled
- **Setup file**: `tests/setup.ts` - mock utilities, test constants, PDF buffer generation
- **Coverage threshold**: 80% (branches, functions, lines, statements)
- **Test timeout**: 30 seconds

Unit tests in `tests/unit/`, integration tests in `tests/integration/` and `tests/integrations/`.

## Code Style

- **Formatter/Linter**: Biome (not ESLint)
- **TypeScript**: Strict mode with all strict flags enabled
- **Target**: ES2022, Node.js 18+
- **Output formats**: CJS (.js) and ESM (.mjs)

## Commit Convention

Uses Conventional Commits: `feat:`, `fix:`, `docs:`, `refactor:`, `test:`, `chore:`, `ci:`, `perf:`

Example: `feat(api): add streaming support for large files`

## OpenAPI Type Generation

The SDK uses `openapi-typescript` to generate TypeScript types from the Docling Serve OpenAPI spec.

### Workflow

1. **Fetch OpenAPI spec** (requires running Docling Serve):
   ```bash
   npm run openapi:fetch  # from http://localhost:5000
   DOCLING_URL=http://custom:5000 npm run openapi:fetch  # custom server
   ```

2. **Generate types**:
   ```bash
   npm run openapi:generate
   ```

3. **Or do both**:
   ```bash
   npm run openapi:update
   ```

### Type Structure

- `src/types/generated/api.ts` - Auto-generated types (DO NOT EDIT)
- `src/types/api.ts` - Manually maintained SDK types (these remain the source of truth)
- `src/types/adapters/` - Functions to transform between SDK and OpenAPI formats

### Usage

```typescript
import { OpenAPI } from 'docling-sdk';

// Access generated types via namespace
type ConvertEndpoint = OpenAPI.paths['/v1/convert/source'];
type TaskStatus = OpenAPI.components['schemas']['TaskStatus'];
```

The generated types supplement (not replace) the manually maintained types in `src/types/api.ts`
